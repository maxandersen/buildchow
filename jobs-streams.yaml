- defaults:
    name: global
    component-responsible: ""
    download-cache:  "$JENKINS_HOME/static_build_env/jbds/download-cache"
    maven-settings: "$JENKINS_HOME/../.m2/local-settings.xml" # need more reliable location
    nodes: &nodes
      "(RHEL6||RHEL7||beaker||jboss-prod)&&!ia64&&!rhts"
    components: &components # an alias for components
      - aerogear
      - arquillian
      - base
      - birt
      - browsersim
      - central
      - forge
      - freemarker
      # - gwt
      - hibernate:
          component-responsible: "jenkinsmail@xam.dk"
      - javaee
      - jst
      - livereload
      - openshift
      - portlet
      - server
      - vpe
      - webservices
    
- project:
    name: jbosstools-master  # 'project' for a certain stream
    stream:
      master
    target-platform-version: 4.50.0.Alpha1-SNAPSHOT
    target-platform-maximum: 4.50.0.Alpha1-SNAPSHOT
    
    branch:
      - master
    component: 
      *components
    jobs:
      - 'jbosstools-{component}_{stream}'
          
- project:
    name: jbosstools-mars 
    stream:
      4.3.mars
    target-platform-version: 4.50.0.Alpha1-SNAPSHOT
    target-platform-maximum: 4.50.0.Alpha1-SNAPSHOT
    branch:
      - jbosstools-4.3.0.Alpha1x
    component: 
      *components  # reusing same component list but could use different one per stream if needed
    jobs:
      - 'jbosstools-{component}_{stream}'
      

- job-template:
    name: 'jbosstools-{component}_{stream}'
    node: *nodes
    logrotate:
      daysToKeep: -1
      numToKeep: 5
      artifactDaysToKeep: -1
      artifactNumToKeep: -1
    jdk: jdk1.7
     
    parameters:
      - string:
          name: MAVEN_FLAGS
          default: "-B -U -fae -e -Djbosstools-site-stream={stream} -P hudson,pack200,unified.target"
          description: "Default flags passed to maven targets"
      - string:
          name: TARGET_PLATFORM_VERSION
          default: "{target-platform-version}"
          description: "Target platform used for building/compilation"
      - string:
          name: TARGET_PLATFORM_MAXIMUM
          default: "{target-platform-maximum}"
          description: "Target platform used for testing"
      - bool:
          name: skipRevisionCheckWhenPublishing
          default: "false"
          description: >-
            Check box to always publish new build to staging / nightly. 
            Unchecked, publish.sh will check previous build's revision to decide if this build
            needs to overwrite the previous one, or if it's in fact the same source and therefore same binaries.
            
    properties:
          
      - github:
          url: https://github.com/jbosstools/jbosstools-{component}

    scm:
      - git:
          url: https://github.com/jbosstools/jbosstools-{component}
          wipe-workspace: false
          basedir: "sources"
          branches: 
            - '{branch}'
        
    triggers:
      - pollscm: "35 0,8,16 * * *"

    builders:
      - maven-target:
          goals: "clean install ${{MAVEN_FLAGS}} -DTARGET_PLATFORM_VERSION=${{TARGET_PLATFORM_VERSION}}"
          maven-version: maven-3.2.5
          settings: "{maven-settings}"
          private-repository: true
          java-opts: 
            - '-Xms512m -Xmx1024m -XX:PermSize=128m -XX:MaxPermSize=256m -Djbosstools.test.jre.5="${{NATIVE_TOOLS}}${{SEP}}${{JAVA15}}" -Djbosstools.test.jre.6="${{NATIVE_TOOLS}}${{SEP}}${{JAVA16}}"'
          properties: 
            - maven.test.skip=true
            - skipITests=true
            - download.cache.directory={download-cache}
            - JOB_NAME=${{JOB_NAME}}
            - BUILD_ID=${{BUILD_ID}}
            - BUILD_NUMBER=${{BUILD_NUMBER}}
            - skipPrivateRequirements=false
          pom: ${{WORKSPACE}}/sources/pom.xml
      - maven-target:
          goals: -B org.apache.maven.plugins:maven-dependency-plugin:2.9:unpack
          maven-version: maven-3.2.5
          private-repository: true
          properties:
            - artifact=org.jboss.tools.releng:jbosstools-releng-publish:4.3.0.Alpha1-SNAPSHOT:zip
            - outputDirectory=${{WORKSPACE}}/sources
            - trimVersion=true
            - mdep.stripClassifier=true
            - mdep.stripVersion=true
      - shell: |
                cd ${{WORKSPACE}}/sources/
                export skipRevisionCheckWhenPublishing=${{skipRevisionCheckWhenPublishing}}
                . publish/publish.sh
      - maven-target:
          goals: deploy ${{MAVEN_FLAGS}}
          maven-version: maven-3.2.5
          pom: ${{WORKSPACE}}/sources/site/pom.xml
          private-repository: true
          properties:
            - download.cache.directory={download-cache}
            - JOB_NAME=${{JOB_NAME}}
            - BUILD_ID=${{BUILD_ID}}
            - BUILD_NUMBER=${{BUILD_NUMBER}}
            - skipPrivateRequirements=false
      - maven-target:
          goals: verify ${{MAVEN_FLAGS}} -DTARGET_PLATFORM_VERSION=${{TARGET_PLATFORM_VERSION_MAXIMUM}}
          maven-version: maven-3.2.5
          java-opts: '-Xms512m -Xmx1024m -XX:PermSize=128m -XX:MaxPermSize=256m -Djbosstools.test.jre.5="${{NATIVE_TOOLS}}${{SEP}}${{JAVA15}}" -Djbosstools.test.jre.6="${{NATIVE_TOOLS}}${{SEP}}${{JAVA16}}"'
          pom: ${{WORKSPACE}}/sources/tests/pom.xml
          private-repository: true
          properties:
            - maven.test.failure.ignore=true
            - download.cache.directory={download-cache}
            - JOB_NAME=${{JOB_NAME}}
            - BUILD_ID=${{BUILD_ID}}
            - BUILD_NUMBER=${{BUILD_NUMBER}}
            - skipPrivateRequirements=false

    publishers:
      - archive: 
          artifacts: "results/*/all/*Update*.zip,sources/*tests/*/target/work/configuration/*.log,sources/*tests/*/target/work/data/.metadata/*.log, sources/target/coverage-report/**"
          latest-only: true
      - junit:
          results: "sources/*tests/*/target/surefire-reports/TEST-*.xml"
          keep-long-stdio: false
      - description-setter:
          regexp: "BUILD_DESCRIPTION='(.+)'"
          description: "\\1"
      - email:
          recipients: "{component-responsible} jbosstools-builds@lists.jboss.org"
          send-to-individuals: true
      - build-publisher:
          name: ""
          publish-unstable-builds: true
          publish-failed-builds: false
          
    wrappers:
      - timeout:
          timeout: 120




